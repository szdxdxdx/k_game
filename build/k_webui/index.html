<!DOCTYPE html>
<html lang="zh">
<head>
  <title>k_webui</title>
  <meta charset="UTF-8">
  <script src="/webui.js"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  
  <style>
    
    /* region [binding-panel] */
    
    #binding-panel {
    
    }
    
    #binding-panel label {
      border: 1px solid #f60;
      margin: 8px;
      padding: 8px;
    }
    
    /* endregion */
    
    /* region [log-panel] */
    
    #log-panel {
    
    }
    
    /* endregion */
  
  </style>

</head>
<body>
<div id="app">
  
  <!-- [widget-panel] --><!-- region -->
  <div id="binding-panel">
    
    <div v-for="[label, binding] in bindings" :key="label">
      <p>{{ binding }}</p>

      <label v-if="binding.type === 'range'">
        <span>{{ binding.label }}</span>
        <span v-show="binding.out_of_range">out of range</span>
        <input type="range" v-model="binding.val" :min="binding.min" :max="binding.max" :step="binding.step"
               @input="binding_range_set_c_val($event, binding.label)" />
      </label>

      <label v-else-if="binding.type === 'checkbox'">
        <span>{{ binding.label }}</span>
        <input type="checkbox" v-model="binding.val" @change="binding_checkbox_set_c_val($event, binding.label)"/>
      </label>
      
      <label v-else-if="binding.type === 'button'">
        <span>{{ binding.label }}</span>
        <input type="button" @click="binding_button_set_c_val($event, binding.label)"/>
      </label>

      <label v-else-if="binding.type === 'select'">
        <span>{{ binding.label }}</span>
        <span v-show="binding.out_of_range">out of range</span>
        <select v-model="binding.val" @change="binding_select_set_c_val($event, binding.label)">
          <option v-for="(option, idx) in binding.options" :key="idx" :value="option.val">{{ option.text }}</option>
        </select>
      </label>

    </div>
  
  </div>
  <!-- endregion -->
  
  <!-- [log-panel] --><!-- region -->
  <div id="log-panel">
    <table>
      <tr v-for="(log, idx) in log_list" :key="idx">
        <td>
          <span>{{ log.level }}</span>
        </td>
        <td>
          <pre>{{ log.msg }}</pre>
        </td>
      </tr>
    </table>
  </div>
  <!-- endregion -->

</div>

<script>
  const {createApp, reactive} = Vue;
  
  const k__webui = createApp({
    data() {
      return {
        bindings: reactive(new Map()),
        sync_timer: null,

        log_list: [ /* { level: 'INFO|WARN|ERROR', msg } */],
      };
    },

    mounted() {
       this.sync_timer = setInterval(this.sync_from_c, 500);
    },

    methods: {
      /* region [binding-panel] */
      
      bind(widget_config) {
        
        let binding = reactive({});
        
        switch (widget_config.type) {
          case 'range': {
            binding.type = 'range';
            binding.label = widget_config.label;
            binding.min   = widget_config.min;
            binding.max   = widget_config.max;
            binding.step  = widget_config.step;
            binding.val   = null;
            binding.out_of_range = false;
            break;
          }
          case 'checkbox': {
            binding.type  = 'checkbox';
            binding.label = widget_config.label;
            binding.val   = null;
            break;
          }
          case 'button': {
            binding.type = 'button';
            binding.label = widget_config.label;
            break;
          }
          case 'select': {
            binding.type    = 'select';
            binding.label   = widget_config.label;
            binding.options = widget_config.options;
            binding.val     = null;
            binding.out_of_range = false;
            break;
          }
        }

        this.bindings.set(binding.label, binding);
      },
      
      binding_range_set_c_val($event, label) {
        let value = $event.target.value;
        k__webui_set_c_val(label, value);
      },
      
      binding_checkbox_set_c_val($event, label) {
        let checked = $event.target.checked;
        k__webui_set_c_val(label, checked);
      },

      binding_button_set_c_val($event, label) {
        k__webui_set_c_val(label);
      },

      binding_select_set_c_val($event, label) {
        let selected = $event.target.value;
        k__webui_set_c_val(label, selected);
      },

      sync_from_c() {

        for (const [label] of this.bindings) {
          k__webui_get_c_val(label).then((val) => {
    
            const binding = this.bindings.get(label);
            if ( ! binding) {
              return;
            }

            switch (binding.type) {
              case 'range': {
                if (val < binding.min || val > binding.max) {
                  binding.out_of_range = true;
                } else {
                  binding.val = val;
                  binding.out_of_range = false;
                }
                break;
              }
              case 'checkbox': {
                binding.val = !!val;
                break;
              }
              case 'select': {
                if ( ! binding.options.find(opt => Number(opt.val) === Number(val) )) {
                  binding.out_of_range = true;
                } else {
                  binding.val = val;
                  binding.out_of_range = false;
                }
                break;
              }
            }
            
            
            
          })
        }
      },

      /* endregion */

      /* region [log-panel] */

      log_info(msg) {
        this.log_list.push({level: 'INFO', msg: `${msg}`});
      },
      log_warn(msg) {
        this.log_list.push({level: 'WARN', msg: `${msg}`});
      },
      log_error(msg) {
        this.log_list.push({level: 'ERROR', msg: `${msg}`});
      }

      /* endregion */
    }
  }).mount('#app');
</script>

</body>
</html>
